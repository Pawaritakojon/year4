<!DOCTYPE html>
<html lang="th" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผลการวางแผนการเงิน - Finance App</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#2c3e50;line-height:1.6;min-height:100vh}
        .header-placeholder{height:70px}
        .container{max-width:1000px;margin:0 auto;padding:40px 20px}
        .page-title{text-align:center;margin-bottom:36px}
        .page-title h1{font-size:2.2rem;font-weight:600;color:#2c3e50;margin-bottom:6px}
        .page-title p{color:#7f8c8d;font-size:1rem}
        .result-container{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:24px;box-shadow:0 20px 40px rgba(0,0,0,.1);padding:36px;animation:slideInUp .8s ease}
        .user-info{background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);color:#fff;padding:26px;border-radius:18px;text-align:center;margin-bottom:26px}
        .user-name{font-size:1.5rem;font-weight:700;margin-bottom:6px}
        .user-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:10px}
        .detail-item{text-align:center}
        .detail-label{font-size:.9rem;opacity:.9;margin-bottom:3px}
        .detail-value{font-size:1.15rem;font-weight:700}
        .section-title{margin:18px 0 12px;font-weight:800;color:#2c3e50;display:flex;align-items:center;gap:10px}
        .badge{display:inline-block;background:#ecf5ff;color:#1b6fbf;border:1px solid #cfe6ff;font-size:.8rem;padding:4px 10px;border-radius:999px}
        .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-bottom:18px}
        .result-card{background:#fff;padding:18px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid #eff1f5;transition:all .25s ease;position:relative;overflow:hidden}
        .result-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,#3498db,#27ae60)}
        .result-card:hover{transform:translateY(-3px)}
        .card-title{font-size:1rem;font-weight:700;color:#2c3e50;margin-bottom:6px}
        .card-value{font-size:1.55rem;font-weight:800;color:#27ae60;margin-bottom:4px;line-height:1.2}
        .card-sub,.card-description{color:#7f8c8d;font-size:.92rem}
        .muted{color:#95a5a6;font-size:.9rem}
        .highlight-card{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff}
        .highlight-card .card-title,.highlight-card .card-value,.highlight-card .card-description{color:#fff}
        .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
        .list{margin:6px 0 0 16px}
        .list li{margin:6px 0}
        .ok{background:#f2fff6;border:1px solid #c7f0d1;border-radius:12px;padding:14px}
        .warn{background:#fff4f4;border:1px solid #ffd8d8;border-radius:12px;padding:14px}
        .divider{height:1px;background:linear-gradient(90deg,rgba(0,0,0,.06),rgba(0,0,0,.02));margin:16px 0 20px}
        .action-buttons{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:8px}
        .action-btn{padding:12px 22px;border:none;border-radius:12px;font-size:15px;font-weight:700;text-decoration:none;transition:.25s ease;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
        .action-btn.primary{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
        .action-btn.secondary{background:transparent;color:#3498db;border:2px solid #3498db}
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(52,152,219,.25)}
        .action-btn.secondary:hover{background:#3498db;color:#fff}
        @keyframes slideInUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        @media (max-width:900px){.two-col{grid-template-columns:1fr}}
        @media (max-width:768px){.result-container{padding:24px}.page-title h1{font-size:1.8rem}.results-grid{grid-template-columns:1fr}.action-btn{width:100%;justify-content:center}}

        .table { width:100%; border-collapse: collapse; }
        .table th, .table td { padding:10px 12px; border-bottom:1px solid #eef0f3; text-align:right; }
        .table th:first-child, .table td:first-child { text-align:left; }
        .table thead th { background:#f8fafc; font-weight:700; color:#415161; position:sticky; top:0; }
        .tools { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin:8px 0 12px; flex-wrap:wrap; }
        .chip { background:#eef6ff; color:#1b6fbf; border:1px solid #cfe6ff; padding:4px 10px; border-radius:999px; font-size:.85rem; }
        canvas { background:#fff; border:1px solid #eff1f5; border-radius:12px; padding:8px; }
    </style>
</head>
<body>
<div th:replace="~{hamburger :: hamburger('home')}"></div>
<div class="header-placeholder"></div>

<div class="container">
    <div class="page-title">
        <h1>ผลการวางแผนการเงิน</h1>
        <p>สรุปผลคำนวณพร้อมสมมติฐานที่สำคัญ และคำแนะนำสำหรับการตัดสินใจ</p>
    </div>

    <div class="result-container">
        <!-- ผู้ใช้ -->
        <div class="user-info">
            <div class="user-name">
                ชื่อ: <span th:text="|${userInfo.firstName} ${userInfo.lastName}|">[ชื่อผู้ใช้]</span>
            </div>
            <div class="user-details">
                <div class="detail-item">
                    <div class="detail-label">อายุปัจจุบัน</div>
                    <div class="detail-value"><span th:text="${userInfo.age}">[อายุ]</span> ปี</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">อายุเกษียณที่ต้องการ</div>
                    <div class="detail-value"><span th:text="${userInfo.retirementAge}">[อายุเกษียณ]</span> ปี</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ระยะเวลาที่เหลือ</div>
                    <div class="detail-value">
                        <span th:text="${yearsToRetirement}">[ปี]</span> ปี (<span th:text="${totalMonths}">[เดือน]</span> เดือน)
                    </div>
                </div>
            </div>
        </div>

        <!-- สรุปตัวเลขหลัก -->
        <div class="section-title"><span class="badge">สรุปสำคัญ</span> ตัวเลขหลักของแผน</div>
        <div class="results-grid">
            <div class="result-card">
                <div class="card-title">เงินเดือนปัจจุบัน (ฐานคำนวณ)</div>
                <div class="card-value"><span th:text="${formattedSalaryNow}">30,000.00</span> บาท</div>
                <div class="card-sub">ฐานการออม & การหักเงินสะสมต่าง ๆ</div>
            </div>

            <div class="result-card">
                <div class="card-title">เป้าหมาย (มูลค่าวันนี้)</div>
                <div class="card-value"><span th:text="${formattedDesiredAmountToday}">10,000,000.00</span> บาท</div>
                <div class="card-sub">จำนวนเงินที่อยากมี ณ วันเกษียณ คิดเป็นมูลค่าวันนี้</div>
            </div>

            <div class="result-card">
                <div class="card-title">เป้าหมาย ณ ปีเกษียณ (หลังเงินเฟ้อ)</div>
                <div class="card-value"><span th:text="${formattedFutureTarget}">17,646,107.00</span> บาท</div>
                <div class="card-sub">เงินเฟ้อเฉลี่ย <b><span th:text="${formattedInflationAnnual} ?: '2.5'">2.5</span>%</b> ต่อปี</div>
            </div>

            <div class="result-card">
                <div class="card-title">สัดส่วนออมฝั่งคุณ</div>
                <div class="card-value"><span th:text="${formattedSavingRatePct}">30.7</span>%</div>
                <div class="card-sub">ออมเป็น “% ของฐานสุทธิหลังหักรายการคงที่”</div>
            </div>

            <div class="result-card">
                <div class="card-title">ออมเดือนแรก (คุณ)</div>
                <div class="card-value"><span th:text="${formattedMonthlySavingYou}">9,195.75</span> บาท</div>
                <div class="card-sub">สัดส่วนออม × ฐานสุทธิ</div>
            </div>

            <div class="result-card">
                <div class="card-title">ค่าประกันสังคม/เดือน (ใช้คำนวณ)</div>
                <div class="card-value">
                    <span th:text="${formattedSocialSecurityUsed}">0.00</span> บาท
                </div>
                <div class="card-sub">ถ้าไม่กรอก ถือว่า 0 บาท/เดือน</div>
            </div>

            <div class="result-card">
                <div class="card-title">กองทุนสำรองเลี้ยงชีพ/เดือน (ใช้คำนวณ)</div>
                <div class="card-value">
                    <span th:text="${formattedProvidentFundUsed}">0.00</span> บาท
                </div>
                <div class="card-sub">ถ้าไม่กรอก ถือว่า 0 บาท/เดือน</div>
            </div>
        </div> <!-- ปิด results-grid -->

        <div class="divider"></div>

        <!-- สมมติฐาน & วิธีคำนวณ -->
        <div class="two-col">
            <div>
                <div class="section-title"><span class="badge">สมมติฐาน</span> ตัวเลขที่ใช้ในโมเดล</div>
                <div class="result-card">
                    <div class="card-title">อัตราที่ใช้</div>
                    <div class="card-sub">
                        • เงินเฟ้อเฉลี่ย: <b><span th:text="${formattedInflationAnnual} ?: '2.5'">2.5</span>%</b> ต่อปี<br/>
                        • ผลตอบแทนการลงทุน: <b><span th:text="${formattedRAnnual}">6.0</span>%</b> ต่อปี (ทบต้นรายเดือน)<br/>
                        • ขึ้นเงินเดือนเฉลี่ย: <b><span th:text="${formattedGAnnual} ?: '4.7'">4.7</span>%</b> ต่อปี<br/>
                        • ย้ายงาน: <b>ทุก ~3 ปี</b> โอกาสได้ขึ้น <b><span th:text="${formattedJobChangeProbPct}">60</span>%</b>
                        และถ้าได้ ขึ้น <b>+<span th:text="${#numbers.formatDecimal(jobChangeRaisePct*100,0,0)}">25</span>%</b><br/>
                        <span class="muted">→ ตัวคูณคาดหวังปีที่ย้ายงาน = 1 + p × raise</span><br/>
                        • ประกันสังคม & PVD: <b>ใช้ค่าที่ผู้ใช้กรอก</b> ถ้าเว้นว่าง = <b>0</b>
                    </div>
                    <div class="muted" style="margin-top:6px">* ปรับสมมติฐานได้ในแบบฟอร์มเพื่อดูผลกระทบ</div>
                </div>

                <div class="section-title"><span class="badge">วิธีคำนวณ (ย่อ)</span></div>
                <div class="result-card">
                    <ol class="list">
                        <li>คูณเงินเฟ้อทุกปี → ได้เป้าหมายมูลค่าอนาคต ณ ปีเกษียณ</li>
                        <li>จำลองเงินเดือนปีต่อปี (ขึ้นเงินเดือน 4.7% + ปัจจัยคาดหวังเมื่อย้ายงาน)</li>
                        <li>ทุกเดือน: หักค่าคงที่ (เช่น SS/PVD จากที่กรอก) → ได้ “ฐานสุทธิ”</li>
                        <li>ออมเป็นสัดส่วนคงที่ของฐานสุทธิ แล้วทบต้นด้วยผลตอบแทนรายเดือน</li>
                        <li>แก้สมการด้วย <b>Binary Search</b> หา % ออมที่ทำให้ยอดถึงเป้า</li>
                    </ol>
                </div>
            </div>

            <div>
                <div class="section-title"><span class="badge">ข้อควรระวัง</span></div>
                <div class="result-card warn">
                    <ul class="list">
                        <li>ผลตอบแทน/เงินเฟ้อเป็นค่าเฉลี่ย—ความผันผวนจริงอาจสูง/ต่ำกว่านี้</li>
                        <li>เงินเดือนอาจไม่ได้ขึ้นตามแผน หรือย้ายงานไม่ได้ตามช่วงที่ตั้ง</li>
                        <li>กติกา SS/PVD อาจเปลี่ยนแปลงในอนาคต</li>
                        <li>โมเดลนี้ไม่รวมภาษี/หนี้/ค่าใช้จ่ายฉุกเฉิน → ควรกันเงินสำรอง 3–6 เดือน</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- ปุ่ม CSV -->
        <div class="section-title"><span class="badge">ข้อมูลรายเดือน</span> ดาวน์โหลดครบทุกเดือน</div>
        <div class="tools">
            <span class="chip">ทั้งหมด <span th:text="${totalMonths}">276</span> เดือน</span>
            <button id="btnExportCsv" class="action-btn secondary">ดาวน์โหลด CSV (ทุกเดือน)</button>
        </div>

        <div class="divider"></div>
        <div class="section-title"><span class="badge">สรุปรายปี</span></div>
        <div class="result-card" style="overflow:auto;">
            <table class="table">
                <thead>
                <tr>
                    <th>ปีที่</th>
                    <th>อายุปลายปี</th>
                    <th>เงินเดือนเฉลี่ย/เดือน</th>
                    <th>ประกันสังคมรวม/ปี</th>
                    <th>กองทุนสำรองเลี้ยงชีพรวม/ปี</th>
                    <th>ออมรวม/ปี</th>
                    <th>ออมเฉลี่ย/เดือน</th>
                    <th>ยอดพอร์ตปลายปี</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="yr : ${yearSummary}">
                    <td th:text="${yr['yearIndex']}">1</td>
                    <td th:text="${yr['ageEnd']}">23</td>
                    <td th:text="${#numbers.formatDecimal(yr['avgSalary'],1,'COMMA',2,'POINT')}">30,000.00</td>
                    <td th:text="${#numbers.formatDecimal(yr['sumSSF'],1,'COMMA',2,'POINT')}">9,000.00</td>
                    <td th:text="${#numbers.formatDecimal(yr['sumPVD'],1,'COMMA',2,'POINT')}">0.00</td>
                    <td th:text="${#numbers.formatDecimal(yr['sumSaving'],1,'COMMA',2,'POINT')}">110,349.00</td>
                    <td th:text="${#numbers.formatDecimal(yr['avgSavingPerMonth'],1,'COMMA',2,'POINT')}">9,195.75</td>
                    <td th:text="${#numbers.formatDecimal(yr['endBalance'],1,'COMMA',2,'POINT')}">115,000.00</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="action-buttons">
            <a href="/caluserinfo" class="action-btn primary">แก้ไขข้อมูล/สมมติฐาน</a>
            <a href="/home" class="action-btn secondary">กลับหน้าแรก</a>
        </div>
    </div>
</div>

<script>
    // Animate cards on load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.result-card').forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(24px)';
            setTimeout(() => {
                card.style.transition = `all .55s ease ${index * 70}ms`;
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 150);
        });
    });
</script>

<!-- Inject ตัวแปรสำหรับ CSV (ไม่มีการวาดกราฟ) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const months   = /*[[${chartMonths}]]*/ [];
    const ages     = /*[[${chartAges}]]*/ [];
    const salary   = /*[[${chartSalary}]]*/ [];
    const ssf      = /*[[${chartSSF}]]*/ [];
    const pvd      = /*[[${chartPVD}]]*/ [];
    const baseNet  = /*[[${chartBase}]]*/ [];
    const saving   = /*[[${chartSaving}]]*/ [];
    const balance  = /*[[${chartBalance}]]*/ [];
    /*]]>*/
</script>

<!-- Export CSV -->
<script th:inline="none">
    (function () {
        const btn = document.getElementById('btnExportCsv');
        if (!btn) return;

        btn.addEventListener('click', function () {
            const rows = [];
            rows.push(['Month','Age','GrossSalary','SocialSecurity','PVD','NetBase','Saving','EndBalance']);
            for (let i = 0; i < months.length; i++) {
                rows.push([
                    months[i], ages[i], salary[i], ssf[i],
                    (Array.isArray(pvd) && pvd[i]!=null ? pvd[i] : 0),
                    baseNet[i], saving[i], balance[i]
                ]);
            }
            const toCsvLine = arr => arr.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(',');
            const csv = rows.map(toCsvLine).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url  = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'finance-plan-monthly.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    })();
</script>
</body>
</html>
